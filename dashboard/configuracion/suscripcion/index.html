<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/assets/img/icon.png?v=1.0.2">
  <link rel="stylesheet" href="/assets/styles/main.css?v=1.0.2">
  <link rel="stylesheet" href="/assets/styles/components/header.css?v=1.0.1">
  <link rel="stylesheet" href="/assets/styles/components/footer.css?v=1.0.1">
  <link rel="stylesheet" href="/assets/styles/components/loader.css?v=1.0.1">
  <title>Gestión de Suscripción - MasterBroker.ai</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      margin-top: 100px;
      min-height: calc(100vh - 159px);
    }

    .footer{
      border-top: none !important;
      bottom: 0px;
    }

    .footer_infer{
      border-top: 1px solid var(--border) !important;
    }

    @media (max-width: 767px) {
      .footer_infer {
          flex-direction: column-reverse;
          padding-left: 20px;
          padding-right: 20px;
          width: auto;
          height: auto;
          justify-items: center;
      }
    }

    @media (max-width: 1024px) {
      .footer_infer {
          width: auto;
          padding-left: 20px;
          padding-right: 20px;
      }
    }
    
    .page-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #1f2937;
    }
    
    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    
    .card-header {
      padding: 15px 20px;
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .plan-name {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .status-active {
      background-color: #d1fae5;
      color: #10b981;
    }
    
    .status-canceled {
      background-color: #fee2e2;
      color: #ef4444;
    }
    
    .status-pending {
      background-color: #fef3c7;
      color: #f59e0b;
    }
    
    .detail-row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }
    
    .detail-col {
      flex: 1;
      min-width: 200px;
      margin-bottom: 15px;
    }
    
    .detail-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .feature-list {
      margin-top: 20px;
    }
    
    .feature-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 15px;
    }
    
    .feature-icon {
      color: #2563eb;
      margin-right: 10px;
    }
    
    .btn-primary {
      background-color: #2563eb;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
    
    .btn-secondary {
      background-color: white;
      color: #2563eb;
      border: 2px solid #2563eb;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-secondary:hover {
      background-color: #dbeafe;
    }
    
    .info-alert {
      background-color: #dbeafe;
      border-left: 4px solid #2563eb;
      padding: 15px;
      margin-top: 25px;
      border-radius: 4px;
    }
    
    .info-alert p {
      margin: 0;
      color: #1f2937;
    }
    
    .billing-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .billing-table th {
      text-align: left;
      padding: 12px;
      background-color: #f9fafb;
      color: #6b7280;
      font-weight: 600;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .billing-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .button-link {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      background-color: #f3f4f6;
      color: #2563eb;
      text-decoration: none;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .button-link:hover {
      background-color: #e5e7eb;
    }
    
    .no-subscription {
      text-align: center;
      padding: 50px 20px;
    }
    
    .no-subscription img {
      max-width: 150px;
      margin: 25px auto;
    }
    
    .no-subscription h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1f2937;
    }
    
    .no-subscription p {
      margin-bottom: 25px;
      color: #6b7280;
    }

    .spinner-border {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      vertical-align: text-bottom;
      border: 0.25em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border 0.75s linear infinite;
    }
    
    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .detail-col {
        flex: 0 0 100%;
      }
      
      .page-title {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div id="loader">
    <div class="spinner">
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  
  <div class="nav_sup">
    <div id="nav-container"></div>
  </div>
  
  <div class="container" id="subscription-container">
    <h1 class="page-title">Gestión de Suscripción</h1>
    
    <!-- El contenido se cargará dinámicamente con JavaScript -->
    <div id="subscription-content">
      <div class="loading-indicator" style="text-align: center; padding: 50px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: #2563eb;"></i>
        <p style="margin-top: 15px;">Cargando información de suscripción...</p>
      </div>
    </div>
  </div>
  
  <div id="footer_container"></div>
  
  <script src="https://js.stripe.com/v3/"></script>
  <script src="/assets/js/components_private.js?v=1.0.2"></script>
  <script src="/assets/js/navigation.js?v=1.0.2"></script>
  <script src="/assets/js/loader.js?v=1.0.2"></script>
  <script src="/assets/js/session_check.js"></script>
  <script>
// Clase para gestionar la sesión
// Clase para gestionar la sesión
class SubscriptionManager {
  constructor() {
    this.apiUrl = '/api/auth/subscription-info.php';
    this.portalUrl = '/api/auth/create-portal-session.php';
    this.sessionManager = new SessionManager();
    this.isTestMode = false; // Se actualizará al cargar la configuración
  }
  
  // Obtener información de suscripción
  async getSubscriptionInfo() {
    try {
      const response = await fetch(this.apiUrl);
      
      if (!response.ok) {
        throw new Error('Error al obtener información de suscripción');
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error:', error);
      return { error: error.message };
    }
  }
  
  // Crear sesión del portal de cliente
  async createPortalSession() {
    try {
      const response = await fetch(this.portalUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error('Error al crear sesión del portal');
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error:', error);
      return { error: error.message };
    }
  }
  
  // Formatear fecha
  formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }
  
  // Determinar el nombre completo del plan
  getPlanName(planType, billingCycle) {
    const typeNames = {
      'basic': 'Básico',
      'professional': 'Profesional',
      'premium': 'Premium',
      'unlimited': 'Ilimitado'
    };
    
    const cycleNames = {
      'monthly': 'Mensual',
      'annual': 'Anual'
    };
    
    const typeName = typeNames[planType] || 'Desconocido';
    const cycleName = cycleNames[billingCycle] || '';
    
    return `${typeName} ${cycleName}`;
  }
  
  // Obtener clase de estatus para el badge
  getStatusClass(status) {
    const statusClasses = {
      'active': 'status-active',
      'trialing': 'status-active',
      'canceled': 'status-canceled',
      'incomplete': 'status-pending',
      'incomplete_expired': 'status-canceled',
      'past_due': 'status-pending',
      'unpaid': 'status-canceled'
    };
    
    return statusClasses[status] || 'status-pending';
  }
  
  // Traducir el estado de la suscripción
  translateStatus(status) {
    const statusTranslations = {
      'active': 'Activa',
      'trialing': 'En prueba',
      'canceled': 'Cancelada',
      'incomplete': 'Pendiente',
      'incomplete_expired': 'Expirada',
      'past_due': 'Pago atrasado',
      'unpaid': 'Sin pago'
    };
    
    return statusTranslations[status] || 'Desconocido';
  }
  
  // Verificar si es una suscripción interna otorgada por Master Broker AI
  isInternalSubscription(subscription) {
    return subscription.stripe_subscription_id === 'sub_internal_unlimited_1' && 
           subscription.stripe_customer_id === 'cus_internal_1';
  }
}

document.addEventListener('DOMContentLoaded', async function() {
  // Verificar si el usuario está logueado
  const sessionManager = new SessionManager();
  if (!sessionManager.isAuthenticated()) {
    window.location.href = '/inicio_sesion.html?redirect=' + encodeURIComponent(window.location.pathname);
    return;
  }
  
  const subscriptionManager = new SubscriptionManager();
  const contentContainer = document.getElementById('subscription-content');
  
  try {
    // Obtener información de suscripción
    const data = await subscriptionManager.getSubscriptionInfo();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    // Actualizar el modo de prueba
    subscriptionManager.isTestMode = data.is_test_mode || false;
    
    // Mostrar banner de modo de prueba si es necesario
    if (subscriptionManager.isTestMode) {
      const testBanner = document.createElement('div');
      testBanner.style.cssText = `
        background-color: #ffcc00;
        color: #333;
        text-align: center;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 8px;
        font-weight: bold;
      `;
      testBanner.innerHTML = '<i class="fas fa-exclamation-triangle"></i> MODO DE PRUEBA - Las transacciones no generan cargos reales';
      contentContainer.parentNode.insertBefore(testBanner, contentContainer);
    }
    
    // Mostrar la información de suscripción o mensaje de suscripción no encontrada
    if (data.subscription) {
      const sub = data.subscription;
      const planName = subscriptionManager.getPlanName(sub.plan_type, sub.billing_cycle);
      const statusClass = subscriptionManager.getStatusClass(sub.status);
      const statusText = subscriptionManager.translateStatus(sub.status);
      
      // Verificar si es una suscripción interna
      const isInternalSubscription = subscriptionManager.isInternalSubscription(sub);
      
      // Determinar límites según el plan (se respetan los límites definidos por el plan)
      const tokensLimit = sub.plan_type === 'basic' ? 10000 : 
                         (sub.plan_type === 'professional' ? 20000 : 50000);
      const propertiesLimit = sub.plan_type === 'basic' ? 5 : 
                             (sub.plan_type === 'professional' ? 15 : 30);
      
      contentContainer.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Tu suscripción actual</h2>
          </div>
          <div class="card-body">
            <h3 class="plan-name">${planName}</h3>
            <div class="status-badge ${statusClass}">${statusText}</div>
            
            <div class="detail-row">
              <div class="detail-col">
                <div class="detail-label">Renovación automática</div>
                <div class="detail-value">${subscriptionManager.formatDate(sub.current_period_end)}</div>
              </div>
              <div class="detail-col">
                <div class="detail-label">Inicio de suscripción</div>
                <div class="detail-value">${subscriptionManager.formatDate(sub.started_at)}</div>
              </div>
              <div class="detail-col">
                <div class="detail-label">Tokens IA mensuales</div>
                <div class="detail-value">${tokensLimit.toLocaleString()}</div>
              </div>
              <div class="detail-col">
                <div class="detail-label">Límite de propiedades</div>
                <div class="detail-value">${propertiesLimit}</div>
              </div>
            </div>
            
            <div class="buttons-container">
              <button id="manageSubscription" class="btn-primary" ${isInternalSubscription ? 'disabled style="opacity:0.6;cursor:not-allowed;"' : ''}>
                <i class="fas fa-cog"></i> Gestionar suscripción
              </button>
              ${sub.status !== 'active' ? 
                `<a href="/planes.html" class="btn-secondary" style="margin-left: 10px;">
                  <i class="fas fa-shopping-cart"></i> Ver planes
                </a>` : ''
              }
            </div>
            
            <div class="info-alert">
              <p><i class="fas fa-info-circle"></i> 
              ${isInternalSubscription ? 
                'No puedes gestionar esta suscripción ya que ha sido otorgada directamente por Master Broker AI. Para cualquier cambio, contacta con soporte.' : 
                'Al hacer clic en "Gestionar suscripción" serás redirigido al portal seguro de Stripe donde podrás actualizar tu método de pago, ver el historial de facturación y gestionar tu plan.'}
              </p>
            </div>
          </div>
        </div>
        
        ${data.invoices && data.invoices.length > 0 ? `
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Historial de facturación</h2>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="billing-table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Importe</th>
                      <th>Estado</th>
                      <th>Período</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.invoices.map(invoice => `
                      <tr>
                        <td>${subscriptionManager.formatDate(invoice.created_at)}</td>
                        <td>MXN $${parseFloat(invoice.amount).toFixed(2)}</td>
                        <td>
                          ${invoice.status === 'paid' ? 
                            '<span class="status-badge status-active" style="margin: 0;">Pagado</span>' : 
                            '<span class="status-badge status-pending" style="margin: 0;">Pendiente</span>'
                          }
                        </td>
                        <td>${subscriptionManager.formatDate(invoice.period_start)} - ${subscriptionManager.formatDate(invoice.period_end)}</td>
                        <td>
                          ${invoice.invoice_url ? 
                            `<a href="${invoice.invoice_url}" target="_blank" class="button-link">
                              <i class="fas fa-file-invoice"></i> Ver factura
                            </a>` : 
                            '<span class="text-muted">No disponible</span>'
                          }
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        ` : ''}
      `;
      
      // Agregar evento al botón de gestionar suscripción solo si no es suscripción interna
      if (!isInternalSubscription) {
        document.getElementById('manageSubscription').addEventListener('click', async function() {
          this.disabled = true;
          const originalText = this.innerHTML;
          this.innerHTML = '<span class="spinner-border"></span> Cargando...';
          
          try {
            const portalData = await subscriptionManager.createPortalSession();
            if (portalData.error) {
              throw new Error(portalData.error);
            }
            
            // Redirigir al portal de Stripe
            window.location.href = portalData.url;
            
          } catch (error) {
            alert('Error: ' + error.message);
            this.disabled = false;
            this.innerHTML = originalText;
          }
        });
      }
      
    } else {
      // Mostrar mensaje de no suscripción
      contentContainer.innerHTML = `
        <div class="card">
          <div class="card-body no-subscription">
            <img src="/assets/img/suscripcion.png" alt="Sin suscripción" />
            <h3>No tienes una suscripción activa</h3>
            <p>Para disfrutar de todas las funcionalidades, contrata uno de nuestros planes.</p>
            <a href="/planes.html" class="btn-primary">Ver planes disponibles</a>
          </div>
        </div>
      `;
    }
    
  } catch (error) {
    console.error('Error:', error);
    contentContainer.innerHTML = `
      <div class="card">
        <div class="card-body" style="text-align: center; padding: 40px 20px;">
          <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;"></i>
          <h3 style="font-size: 20px; margin-bottom: 10px;">Error al cargar la información</h3>
          <p style="margin-bottom: 20px;">${error.message || 'Ha ocurrido un error inesperado. Por favor, intenta nuevamente más tarde.'}</p>
          <button onclick="window.location.reload()" class="btn-primary">Reintentar</button>
        </div>
      </div>
    `;
  }
});
  </script>
</body>
</html>